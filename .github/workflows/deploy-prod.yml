name: Deploy Frontend to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Trigger Production Deployment via Webhook
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # Escape commit message to handle newlines
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | jq -Rs .)
          
          PAYLOAD=$(jq -n \
            --arg ref "refs/heads/main" \
            --arg name "ar-ui" \
            --arg full_name "ezmedtech-ai/ar-ui" \
            --arg pusher "github-actions" \
            --arg sha "${{ github.sha }}" \
            --argjson message "$COMMIT_MSG" \
            '{
              ref: $ref,
              repository: {
                name: $name,
                full_name: $full_name
              },
              pusher: {
                name: $pusher
              },
              head_commit: {
                id: $sha,
                message: $message
              }
            }')
          
          SIGNATURE="sha256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            -d "$PAYLOAD" \
            https://ar.clinqly.ai/webhook)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Deployment webhook triggered successfully"
            exit 0
          else
            echo "❌ Deployment webhook failed"
            exit 1
          fi